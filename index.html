<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>Document</title>
</head>
<body>
	<script src="engine/DisplayObject.js"></script>
	<script src="engine/Container.js"></script>
	<script src="engine/Loader.js"></script>
	<script src="engine/Renderer.js"></script>
	<script src="engine/Sprite.js"></script>
	<script>
		
		// вытаскиваем классы из GameEngine
		const { Loader, Renderer, Sprite, Container } = GameEngine

		let spriteTank = null
		let spriteEnemy = null
		let spriteBullet = null
		let container = null
		let containerEnemy = null
		let spriteBackground = null

		const loader = new Loader
		const renderer = new Renderer({
			width: 500,
			height: 500,
			background : 'black',

			update (timestamp) {
				if (!spriteTank || !spriteEnemy || !spriteBullet) {
					return
				}

				moveTanks(container, timestamp)
				moveTanks(containerEnemy, timestamp)

				// движение пули
				if ( spriteBullet.x < renderer.canvas.width * 3) {
					spriteBullet.limit = spriteBullet.limit || 0
					spriteBullet.x = (timestamp - spriteBullet.limit) /2
				} else {
					spriteBullet.limit = timestamp
					spriteBullet.x = 0
				}

				// движение контейнеров танков
				function moveTanks(container, timestamp) {
					container.direction = container.direction || 'right'
					container.time = container.time || - container.x
					const halfSize = container.height / 2

					if (container.direction === 'right') {
						container.x = (timestamp - container.time) / 5 + halfSize
						
						if (container.x >= renderer.canvas.width - halfSize) {
							container.direction = 'rotationDown'
							container.time = timestamp
						}
					}
					else if (container.direction === 'rotationDown') {
						container.angle = Math.PI / 2 * (timestamp - container.time) 
						container.rotation = - container.angle / 1000

						if (container.angle / 1000 > Math.PI / 2) {
							container.rotation = - Math.PI / 2
							container.direction = 'down'
							container.time = timestamp
						}
					}
					else if (container.direction === 'down') {
						container.y = (timestamp - container.time) / 5 + halfSize

						if (container.y >= renderer.canvas.height - halfSize) {
							container.time = timestamp
							container.direction = 'rotationLeft'
						}
					} 
					else if (container.direction === 'rotationLeft' ) {
						container.angle = Math.PI / 2 * (timestamp - container.time)
						container.rotation = - Math.PI / 2 - container.angle / 1000

						if ((Math.PI / 2 + container.angle / 1000) > Math.PI ) {
							container.rotation = - Math.PI
							container.direction = 'left'
							container.time = timestamp
						}
					}
					else if (container.direction === 'left') {
						container.x = renderer.canvas.width - halfSize - (timestamp - container.time) / 5

						if (container.x <= halfSize) {
							container.time = timestamp
							container.direction = 'rotationUp'
						}
					}
					else if (container.direction === 'rotationUp' ) {
						container.angle = Math.PI / 2 * (timestamp - container.time)
						container.rotation = - Math.PI - container.angle / 1000
						if ((Math.PI + container.angle / 1000) > Math.PI * 1.5 ) {
							container.rotation = - Math.PI * 1.5
							container.direction = 'up'
							container.time = timestamp
						}
					}
					else if (container.direction === 'up') {
						container.y = renderer.canvas.height - halfSize - (timestamp - container.time) / 5

						if (container.y < halfSize) {
							container.time = timestamp
							container.direction = 'rotationRight'
						}
					}
					else if (container.direction === 'rotationRight' ) {
						container.angle = Math.PI / 2 * (timestamp - container.time)
						container.rotation = - Math.PI * 1.5 - container.angle / 1000

						if ((Math.PI * 1.5 + container.angle / 1000) > Math.PI * 2 ) {
							container.rotation = 0
							container.direction = 'right'
							container.time = timestamp
						}
					}
				}

			}
		})

		document.body.append(renderer.canvas)

		loader.addImage('tank', 'static/tank.jpg')
		loader.addImage('bullet', 'static/bullet.jpg')
		loader.addImage('background', 'static/background.png')
		loader.addImage('enemy', 'static/enemy.jpg')


		loader.load(() => {
			// выводим изображения на страницу
			// стартовая инициализация спрайта
			spriteTank = new Sprite(loader.getImage('tank'), {
				x: 0,
				y: 0,
				scale: 1,
				anchorX: 0.5,
				anchorY: 0.5
			})

			spriteEnemy = new Sprite(loader.getImage('enemy'), {
				x: 0,
				y: 0,
				scale: 1,
				anchorX: 0.5,
				anchorY: 0.5
			})

			spriteBullet = new Sprite(loader.getImage('bullet'), {
				x: 200,
				y: 0,
				scale: 0.8,
				anchorX: 0.5,
				anchorY: 0.5
			})

			spriteBackground = new Sprite(loader.getImage('background'), {
				x: 0,
				y: 0,
				scale: 1.27,
			})

			container = new Container()
			container.x = 30
			container.y = 30
			container.height = 60

			containerEnemy = new Container()
			containerEnemy.x = 1900
			containerEnemy.y = 30
			containerEnemy.height = 60

			const background = new Container()
			background.x = container.height 
			background.y = container.height
			background.width = renderer.canvas.width - background.x
			background.height = renderer.canvas.height - background.y

			renderer.stage.add(container)
			renderer.stage.add(containerEnemy)
			renderer.stage.add(background)

			container.add(spriteBullet)
			container.add(spriteTank)
			containerEnemy.add(spriteEnemy)
			background.add(spriteBackground)

		})

	</script>
</body>
</html>